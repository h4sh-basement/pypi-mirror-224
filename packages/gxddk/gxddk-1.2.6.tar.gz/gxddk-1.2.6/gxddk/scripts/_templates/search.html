{% extends "!search.html" %}

{% block extrahead %}
<script>
  window.addEventListener('pageshow', function(event) {
    if (event.persisted) {
      window.location.reload();
    }
  });
</script>
<script type="text/javascript">
  function fetchAllHtmlFiles(callback) {
    fetch("_static/html_files.json")
      .then(function (response) {
        return response.json();
      })
      .then(function (htmlFiles) {
        var results = [];
        var fetched = 0;
        var maxConcurrentRequests = 5; // 限制并发请求数量，你可以根据需要调整这个值
        var inProgressRequests = 0;
        var nextIndexToFetch = 0;

        function fetchNext() {
          if (nextIndexToFetch < htmlFiles.length) {
            var file = htmlFiles[nextIndexToFetch];
            var index = nextIndexToFetch;
            nextIndexToFetch++;

            inProgressRequests++;
            fetch(file)
              .then(function (response) {
                return response.text();
              })
              .then(function (text) {
                results[index] = text;
                fetched++;

                if (fetched === htmlFiles.length) {
                  callback(htmlFiles, results);
                } else {
                  inProgressRequests--;
                  fetchNext();
                }
              });
          }
        }

        for (var i = 0; i < maxConcurrentRequests; i++) {
          fetchNext();
        }
      });
  }
  function titleToAnchor(title) {
    return title.trim().toLowerCase().replace(/\s+/g, '-');
  }
  function removeNumberDotSpacePrefix(str) {
    return str.replace(/^(\d+\.)*\s+/, '');
  }

  function removeScripts(html) {
    return html.replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi, "");
  }

  function removeHtmlTags(text) {
    return text.replace(/<\/?[^>]+(>|$)/g, "");
  }
  function extractContext(noHtmlContent, query, contextLength) {
    var queryIndex = noHtmlContent.indexOf(query);
    var startIndex = Math.max(0, queryIndex - contextLength);
    var endIndex = Math.min(noHtmlContent.length, queryIndex + query.length + contextLength);
    var context = noHtmlContent.slice(startIndex, endIndex).replace(query, '<mark>' + query + '</mark>');

    var title = '';
    var titleEndIndex = noHtmlContent.lastIndexOf('¶',queryIndex);
    if (titleEndIndex !== -1) {
      var titleStartIndex = noHtmlContent.lastIndexOf('\n', titleEndIndex - 1);
      if (titleStartIndex === -1) {
        titleStartIndex = 0;
      }
      title = noHtmlContent.slice(titleStartIndex, titleEndIndex).trim();
      title = removeNumberDotSpacePrefix(title);
    }
    return { context, title };
  }

  function extractTitle(htmlContent) {
    var parser = new DOMParser();
    var doc = parser.parseFromString(htmlContent, "text/html");
    var title = doc.querySelector("head > title");
    title = title ? title.textContent : "无标题";
    //var titleParts = title.split(' —');
    var titleEndIndex = title.lastIndexOf(' — ', title.length);
    if (titleEndIndex !== -1) {
        title = title.slice(0, titleEndIndex);
    }
    return title
  }

  window.onload = function () {
    var searchForm = document.getElementById("rtd-search-form");
    var searchResults = document.getElementById("search-results");

    fetchAllHtmlFiles(function (htmlFiles, htmlContents) {
      var query = searchForm.querySelector("input[name='q']").value;
      if (!query) {
          const url = window.location.href;
          const queryParams = new URL(url).searchParams;
          const rawQValue = queryParams.get('q');
          query = decodeURIComponent(rawQValue);
      }
      console.log(query);
      if (!query) {
          return
      }
      var contextLength = 100;

      while (searchResults.firstChild) {
        searchResults.removeChild(searchResults.firstChild);
      }

      htmlContents.forEach(function (htmlContent, index) {
        htmlContent = removeScripts(htmlContent);
        var noHtmlContent = removeHtmlTags(htmlContent);
        // 找到第一个 '¶' 的位置
        var cutStartIndex = noHtmlContent.indexOf('¶');

        // 如果找到了 '¶'，则截取字符串，否则设为空(因为该字符表示标题，缺少该字符说明md没有标题)
        noHtmlContent = cutStartIndex !== -1 ? noHtmlContent.substring(cutStartIndex + 1) : " ";
        
        // 找到 '版权解释' 的位置
        var cutEndIndex = noHtmlContent.indexOf('版权所有 解释权归杭州国芯所有');

        noHtmlContent = cutEndIndex !== -1 ? noHtmlContent.substring(0, cutEndIndex) : noHtmlContent;
        if (noHtmlContent.includes(query)) {
          var ret = extractContext(noHtmlContent, query, contextLength);
          var context = ret.context;
          var title = ret.title;
          var h1_title = extractTitle(htmlContent);
          var li = document.createElement("li");
          var a = document.createElement("a");
          if (title !== ""){
            // 有子标题
            a.href = htmlFiles[index] + "#" + titleToAnchor(title);
            a.innerHTML = "<h3>"+"章节：" + h1_title +  " —— " + title + "</h3>" + "匹配到的结果：" + htmlFiles[index] + "<br><div style='margin-top: 2%;font-size: 90%;color: grey'>"+context+"</div>"+"<br>" ;
          }else{
            // 有无子标题
            a.href = htmlFiles[index];
            a.innerHTML = "<h3>"+"章节：" + h1_title +"</h3>" + "匹配到的结果：" + htmlFiles[index] + "<br><div style='margin-top: 2%;font-size: 90%;color: grey'>"+context+"</div>"+"<br>" ;
          }
          li.appendChild(a);
          searchResults.appendChild(li);
        }
      });
    });
  };
</script>
{% endblock %}
