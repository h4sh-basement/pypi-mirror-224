{% load private_tags %}
<!DOCTYPE html>
<html{% block htmlattributes %} lang="en"{% endblock %}>
<head>
    {% block prehead %}{% endblock %}
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block headtitle %}Simulate User Base{% endblock %}</title>
    <style>
        /* Add a red border to the main content */
        html, body {
            --bar-background-color: rgba(112, 133, 100, 0.61);
            height: 100%;
            margin: 0;
            padding: 0;
        }
        body #everything-wrapper {
            width: 100%;
            height: 100vh;
            display: grid;
            grid-template-rows: auto 1fr;
            overflow: hidden;
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        #everything-wrapper #main-content {
            padding: 10px;
            overflow-y: auto;
        }

        #everything-wrapper #main-content.enabled.showing {
            border: 2px solid red;
        }

        #everything-wrapper #main-content.disabled.showing {
            border: 2px solid var(--bar-background-color, rgba(112, 133, 100, 0.61));
        }


        #everything-wrapper #simulate-user-wrapper {
            display: flex;
            flex-direction: column;
            background-color: var(--bar-background-color, rgba(112, 133, 100, 0.61));
            padding: 5px;
            gap: 5px;
        }

        #simulate-user-wrapper div p {
            margin: 0;
        }

        #simulate-user-wrapper .simulate-user-main-bar {
            display: flex;
            width: 100%;
            justify-content: space-between;
        }

        #simulate-user-wrapper .simulate-user-secondary-bar {
            width: 100%;
        }

        #simulate-user-wrapper .simulate-user-secondary-bar form {
            flex-grow: 1;
        }

        #simulate-user-wrapper .simulate-user-secondary-bar, #simulate-user-wrapper .simulate-user-secondary-bar form {
            display: flex;
            gap: 5px;
            justify-content: space-between;
        }

        #simulate-user-wrapper .simulate-user-secondary-bar form li {
            display: flex;
            gap: 5px;
            list-style-type: none;
        }

        #simulate-user-wrapper.collapsed .simulate-user-secondary-bar {
            display: none;
        }
    </style>
    {% block extrahead %}{% endblock %}
</head>
<body>
    <div id="everything-wrapper">
        {% if show_simulated_user_control_bar %}
            <div id="simulate-user-wrapper" class="collapsed">
                <!-- Display real and simulated user information -->
                <div class="simulate-user-main-bar">
                    <p><strong>Real User:</strong> {{ request.real_user.username }}</p>
                    <p><strong>Simulated User:</strong> {{ request.user.username }}</p>
                    <p><strong>Time since last change:</strong> <span id="simulate-user-simulation-timer">{{ time_since_last_change }}</span></p>
                    <a href="{% url 'admin:index' %}"><button>Admin Site</button></a>
                    <button id="expand-simulate-user-bar-toggle">Expand</button>
                </div>

                <!-- Form to switch user -->
                <div class="simulate-user-secondary-bar">
                    <form action="{% url 'simulate_user_switch_user' %}" method="post">
                        {% csrf_token %}
                        {{ simulate_user_form.as_ul }}
                        <button type="submit">Switch User</button>
                    </form>
                </div>
            </div>
        {% endif %}

        <!-- Main content area with red border -->
        <div id="main-content" class="{% if simulated_user_control_bar_enabled %}enabled{% else %}disabled{% endif %} {% if show_simulated_user_control_bar %}showing{% else %}hidden{% endif %}">
            {% block maincontent %}{% endblock %}
        </div>
    </div>
    <script>
        {% if show_simulated_user_control_bar %}
        const toggleButton = document.getElementById('expand-simulate-user-bar-toggle');
        const wrapper = document.getElementById('simulate-user-wrapper');

        toggleButton.addEventListener('click', () => {
            if (wrapper.classList.contains('collapsed')) {
                wrapper.classList.remove('collapsed');
                wrapper.classList.add('expanded');
                toggleButton.innerText = 'Collapse';
            } else {
                wrapper.classList.remove('expanded');
                wrapper.classList.add('collapsed');
                toggleButton.innerText = 'Expand';
            }
        });

        let timerDisplay = document.getElementById('simulate-user-simulation-timer').textContent;
        if (/^\d+:\d{2}:\d{2}$/.test(timerDisplay)) {
            let [hours, minutes, seconds] = timerDisplay.split(":").map(Number);

            // Convert initial time to milliseconds
            let initialTime = hours * 3600000 + minutes * 60000 + seconds * 1000;
            let startTime = Date.now() - initialTime;

            let timerInterval;

            function startTimer() {
                timerInterval = setInterval(() => {
                    let timeElapsed = Date.now() - startTime;
                    let hrs = Math.floor(timeElapsed / 3600000);
                    timeElapsed %= 3600000;
                    let mins = Math.floor(timeElapsed / 60000);
                    timeElapsed %= 60000;
                    let secs = Math.floor(timeElapsed / 1000);

                    let formattedTime = `${strPad(hrs, 2)}:${strPad(mins, 2)}:${strPad(secs, 2)}`;
                    document.getElementById('timer').textContent = formattedTime;
                }, 1000);
            }

            function strPad(value, length) {
                return value.toString().padStart(length, '0');
            }

            startTimer();
        }
        {% endif %}
    </script>

    {% block extrabody %}{% endblock %}

</body>
</html>